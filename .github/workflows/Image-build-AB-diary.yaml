name: Common Deployment Pipeline

on:
  pull_request:
    branches:
      - main
      - develop
      - release/*
  workflow_dispatch:
    inputs:
      services:
        required: true
        description: "Service name in kubernetes cluster in comma separated format"
        type: string
  push:
    branches:
      - main
      - develop
      - release/*


jobs:
  check-diff:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.create_matrix.outputs.matrix }}
    steps:
      - name: Set github branch
        run: |
          if [[ github.event_name == 'pull_request' && github.event.action == 'closed' ]]; then
            echo "BRANCH=${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV
          elif [[ github.event_name == 'pull_request' && github.event.action == 'opened' ]]; then
            echo "BRANCH=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV
          else
            echo "BRANCH=${{ github.event.ref }}" >> $GITHUB_ENV
          fi 
          echo " set the branch for current job as ${{ env.BRANCH }}"
      
      # - name: check diff
      #   if: github.event_name == 'pull_request'
      #   run: |
      #     git diff ${{ github.event.pull_request.base.ref }} ${{ github.event.pull_request.head.ref }} --name-only | cat > diff.txt

      - name: create matrix
        id: create_matrix
        run: |
          if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            csv="${{ inputs.services }}"
            echo "Input CSV: $csv"

            # Convert CSV â†’ JSON array
            json=$(jq -c -R 'split(",") | map(. | gsub("^\\s+|\\s+$"; ""))' <<< "$csv")

            echo "JSON Array: $json"

            # Export as matrix
            echo "matrix=$json" >> "$GITHUB_OUTPUT"
          fi
  
build-docker-image:
  runs-on: ubuntu-latest
  needs: check-diff
  strategy:
    matrix:
      service: ${{ fromJSON(needs.check-diff.outputs.matrix) }}
  steps:
    - name: Print Service Name
      run: |
        echo "Service Name: ${{ matrix.service }}"

