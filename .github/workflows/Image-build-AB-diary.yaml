name: Common Deployment Pipeline

on:
  pull_request:
    branches:
      - main
      - develop
      - release/*
      - develop-actions
  workflow_dispatch:
    inputs:
      services:
        required: true
        description: "Service name in kubernetes cluster in comma separated format"
        type: string
  push:
    branches:
      - main
      - develop
      - release/*


jobs:
  check-diff:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.create_matrix.outputs.matrix }}
    steps:
      - name: Set github branch
        run: |
          BRANCH=""
          if [[ github.event_name == 'pull_request' && github.event.action == 'closed' ]]; then
            echo "BRANCH=${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV
          elif [[ github.event_name == 'pull_request' && github.event.action == 'opened' ]]; then
            echo "BRANCH=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV
          else
            echo "BRANCH=${{ github.event.ref }}" >> $GITHUB_ENV
          fi 
          echo " set the branch for current job as ${{ env.BRANCH }}"

      - name: checkout
        uses: actions/checkout@v4
        if: github.event_name == 'pull_request'
        with:
          ref: ${{ env.BRANCH }}

      - name: check diff
        if: github.event_name == 'pull_request'
        run: |
          CONFIG_FILE="build/config.json"
          FILE_LIST=$(git diff ${{ github.event.pull_request.base.ref }} ${{ github.event.pull_request.head.ref }} --name-only)
          BASE_PATHS=$(jq -r '.[] | .service_source_path' "$CONFIG_FILE")
          
          if [ -z "$BASE_PATHS" ]; then
             echo "Error: Could not read base paths from $CONFIG_FILE or file is empty."
             # Do not exit 1 here if the config might be optionally empty,
             # but for mandatory services, exiting is fine.
             echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
             exit 0
          fi
          
          MATRIX_ARRAY=""
          
          echo "$BASE_PATHS" | while read -r PATH_PREFIX; do
            if [ -z "$PATH_PREFIX" ]; then
              continue
            fi
            echo "$FILE_LIST" | grep -q "^$PATH_PREFIX"
            
            if [ $? -eq 0 ]; then
              if [ -z "$MATRIX_ARRAY" ]; then
                MATRIX_ARRAY="{\"path\":\"$PATH_PREFIX\"}"
              else
                MATRIX_ARRAY="$MATRIX_ARRAY,{\"path\":\"$PATH_PREFIX\"}"
              fi
            fi
          done
          
          FINAL_JSON="{\"include\":[${MATRIX_ARRAY}]}"
          
          echo "Generated Matrix JSON: $FINAL_JSON"
          
          echo "matrix=$FINAL_JSON" >> $GITHUB_OUTPUT

      - name: create matrix
        id: create_matrix
        run: |
          if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            csv="${{ inputs.services }}"
            echo "Input CSV: $csv"

            # Convert CSV â†’ JSON array
            json=$(jq -c -R 'split(",") | map(. | gsub("^\\s+|\\s+$"; ""))' <<< "$csv")

            echo "JSON Array: $json"

            # Export as matrix
            echo "matrix=$json" >> "$GITHUB_OUTPUT"
          fi
  
  build-docker-image:
    runs-on: ubuntu-latest
    needs: check-diff
    strategy:
      matrix:
          service: ${{ fromJSON(needs.check-diff.outputs.matrix) }}
    steps:
      - name: Print Service Name
        run: |
          echo "Service Name: ${{ matrix.service }}"
