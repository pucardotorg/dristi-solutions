name: Common Deployment Pipeline

on:
  pull_request:
    branches:
      - main
      - develop
      - release/*
      - develop-actions
  workflow_dispatch:
    inputs:
      services:
        required: true
        description: "Service name in kubernetes cluster in comma separated format (eg: service1, service2)"
        type: string
      deployment_env:
        required: true
        description: "Deployment environment (eg: dev, qa, demo)"
        type: list
        default: dev
        options:
          - dev
          - qa
          - demo

  push:
    branches:
      - main
      - develop
      - release/*


jobs:
  check-diff:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.create_matrix.outputs.matrix }}
      deployment_env: ${{ steps.set_deployment_environment.outputs.deployment_env }}
    steps:
      - name: Set github branch
        run: |
          BRANCH=""
          if [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "closed" ]]; then
            BRANCH="${{ github.event.pull_request.base.ref }}"
          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "synchronize" ]]; then
            BRANCH="${{ github.event.pull_request.head.ref }}"
          else
            BRANCH="${{ github.event.ref }}"
          fi 

          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

          # show value *now* using shell variable
          echo "Set the branch for current job as $BRANCH"

      - name: checkout
        uses: actions/checkout@v4
        if: github.event_name == 'pull_request'
        with:
          ref: ${{ env.BRANCH }}

      - name: check diff
        if: github.event_name == 'pull_request'
        id: check_diff
        run: |
          git fetch --all --prune
          
          BASE="origin/${{ github.event.pull_request.base.ref }}"
          HEAD="origin/${{ github.event.pull_request.head.ref }}"

          git diff --name-only "$BASE" "$HEAD" > changed.txt

          services=$(jq -r 'to_entries[] | "\(.key) \(.value.service_source_path)"' build/config.json |
          while read svc raw_path; do
            path=$(echo "$raw_path" | sed 's:/*$::')

            if grep -q "^$path/" changed.txt; then
              echo "$svc"
            fi
          done | sort -u)

          echo "Changed services:"
          echo "$services"

          # SAFE JSON conversion
          matrix=$(printf "%s\n" "$services" | jq -R -s -c '
            split("\n")
            | map(select(. != ""))
            | map(.)
          ')

          echo "Matrix JSON:"
          echo "$matrix"

          echo "matrix=$matrix" >> $GITHUB_OUTPUT

      - name: create matrix
        id: create_matrix
        run: |
          if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            csv="${{ inputs.services }}"
            echo "Input CSV: $csv"

            # Convert CSV â†’ JSON array
            json=$(jq -c -R 'split(",") | map(. | gsub("^\\s+|\\s+$"; ""))' <<< "$csv")

            echo "JSON Array: $json"

            # Export as matrix
            echo "matrix=$json" >> "$GITHUB_OUTPUT"
          elif [[ "$GITHUB_EVENT_NAME" == "pull_request" ]]; then
            echo "Using matrix from check_diff step"
            MATRIX='${{ steps.check_diff.outputs.matrix }}'
            echo "Matrix JSON: $MATRIX"
            echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"
          fi

      - name: set deployment environment
        id: set_deployment_environment
        run: |
          DEPLOYMENT_ENV=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            DEPLOYMENT_ENV="${{ inputs.deployment_env }}"
          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "closed" ]]; then
            if [[ "${{ github.event.pull_request.head.ref }}" == "main" ]]; then
              DEPLOYMENT_ENV="demo"
            elif [[ "${{ github.event.pull_request.head.ref }}" == "develop" ]]; then
              DEPLOYMENT_ENV="dev"
            elif [[ "${{ github.event.pull_request.head.ref }}" == "release/*" ]]; then
              DEPLOYMENT_ENV="qa"
            else
              DEPLOYMENT_ENV="dev"
            fi
          fi
          echo "deployment_env set to $DEPLOYMENT_ENV"
          echo "deployment_env=$DEPLOYMENT_ENV" >> $GITHUB_ENV

  build-and-push-docker-image:
    runs-on: ubuntu-latest
    needs: check-diff
    strategy:
      matrix:
          service: ${{ fromJSON(needs.check-diff.outputs.matrix) }}
          deployment_env: ${{ needs.check-diff.outputs.deployment_env }}
    steps:
      - name: Print Service Name
        run: |
          echo "Service Name: ${{ matrix.service }}"
          echo "Deployment Environment: ${{ matrix.deployment_env }}"
