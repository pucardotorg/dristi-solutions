name: Common Deployment Pipeline

on:
  pull_request:
    branches:
      - main
      - develop
      - release/*
  workflow_dispatch:
    inputs:
      services:
        required: true
        description: "Service name in kubernetes cluster in comma separated format"
        type: string
  push:
    branches:
      - main
      - develop
      - release/*


jobs:
  check-diff:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.create_matrix.outputs.matrix }}
    steps:
      - name: Set github branch
        run: |
          if [[ github.event_name == 'pull_request' && github.event.action == 'opened' ]]; then
            echo "BRANCH=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV
          else
            echo "BRANCH=${{ github.event.ref }}" >> $GITHUB_ENV
          fi 
          echo " set the branch for current job as ${{ env.BRANCH }}"
      
      # - name: check diff
      #   if: github.event_name == 'pull_request'
      #   run: |
      #     git diff ${{ github.event.pull_request.base.ref }} ${{ github.event.pull_request.head.ref }} --name-only | cat > diff.txt

      - name: create matrix
        id: create_matrix
        run: |
          if [[ github.event_name == 'workflow_dispatch' ]]; then
            csv="${{ github.event.inputs.services }}"
            echo "csv=$csv"
            json=$(jq -R 'split(",")' <<< "$csv")
            echo "json=$json"
            echo "matrix=$json" >> $GITHUB_OUTPUT
          # elif [[ github.event_name == 'pull_request' ]]; then
          #   echo "matrix=[{\"services\": \"testing"}]" >> $GITHUB_OUTPUT
          fi
  
  build-docker-image:
    runs-on: ubuntu-latest
    needs: check-diff
    strategy:
      matrix: ${{ fromJSON(needs.check-diff.outputs.matrix) }}
    steps:
      - name: Print Service Name
        run: |
          echo "Service Name: ${{ matrix.service }}"
